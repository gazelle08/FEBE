<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiUdin - Video Pengantar Untuk Pecahan</title>
    <link rel="stylesheet" href="../CSS/detail.module.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <div class="logo-icon"><img src="../Asset/Logo.png" alt=""></div>
                <h1 class="welcome-title">Si<span>Udin</span></h1>    
            </div>              
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="nav-link">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="nav-link active">Fitur<i class="fas fa-chevron-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="../HTML/modul.html" class="dropdown-item">Module</a></li>
                        <li><a href="../HTML/missions.html" class="dropdown-item">Mission</a></li>
                        <li><a href="../HTML/leaderboard.html" class="dropdown-item">Leaderboard</a></li>
                    </ul>
                </li>
                <li><a href="../HTML/dashboard.html" class="nav-link">Dashboard</a></li>
            </ul>
            <div class="nav-actions">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <div class="user-profile">
                    <a href="../HTML/dashboard.html"><img src="../Asset/avatar-dashboard.png" alt="User Profile" class="profile-img"></a>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="video-section">
            <h2 class="video-title" id="module-video-title"></h2>
            <div class="video-container">
                <iframe 
                    id="module-video-iframe"
                    src="" 
                    title="Video Pengantar Untuk Pecahan" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
        </section>

        <section class="content-section">
            <div class="description-container">
                <h3 class="section-title">Description</h3>
                <p class="description-text" id="module-description">
                </p>
                <div class="video-meta">
                    <p><strong>Durasi Video:</strong> <span id="module-duration">N/A</span></p>
                    <p><strong>Tingkat Kesulitan:</strong> <span id="module-difficulty"></span></p>
                    <p><strong>Hingga <span id="module-xp">50XP</span></strong></p>
                </div>
                <button class="quiz-btn" id="start-quiz-btn">Start Quiz</button>
            </div>

            <div class="journey-container">
                <div class="journey-box">
                    <h3 class="journey-title">Your Math Journey</h3>
                    <div class="lesson completed">
                        <span class="check-icon"><i class="fas fa-check-circle"></i></span>
                        <div class="lesson-info">
                            <p class="lesson-code">MTH001:</p>
                            <p class="lesson-name">Pengantar Untuk Pecahan</p>
                        </div>
                    </div>
                    <div class="lesson next">
                        <span class="next-icon"><i class="fas fa-arrow-right"></i></span>
                        <p class="lesson-name">Next Video</p>
                    </div>
                    <div class="lesson locked">
                        <span class="lock-icon"><i class="fas fa-lock"></i></span>
                        <p class="lesson-name">Persamaan Linear dan Variabel</p>
                    </div>
                </div>

                <div class="question-box">
                    <div class="question-header">
                        <i class="fas fa-comments"></i>
                        <h3 class="question-title">What did you learn from this video?</h3>
                    </div>
                    <div class="question-content">
                        <p>Ask Question Bellow</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="navigation-section">
            <button class="nav-btn back" onclick="window.location.href='modul.html'">Back To Module</button>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 class="footer-brand">Si<span>Udin</span></h4>
                    <p>Contact Us</p>
                    <p>support@siudin.com</p>
                </div>
                <div class="footer-section">
                    <h4>Menu</h4>
                    <ul>
                        <li><a href="../HTML/home.html">Home</a></li>
                        <li><a href="#">Fitur</a></li>
                        <li><a href="#">Insights</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Help</h4>
                    <ul>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Follow Us</h4>
                    <div class="social-links">
                        <a href="#"><img src="../Asset/face book.png" alt=""></a>
                        <a href="#"><img src="../Asset/twitter.png" alt=""></a>
                        <a href="#"><img src="../Asset/instagram.png" alt=""></a>
                        <a href="#"><img src="../Asset/youtub.png" alt=""></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Â© 2025 SiUdin. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const moduleId = urlParams.get('moduleId');
            const token = localStorage.getItem('jwtToken');

            if (!moduleId) {
                alert('Module ID is missing from the URL.');
                window.location.href = 'modul.html';
                return;
            }

            async function fetchModuleDetails() {
                try {
                    const response = await fetch(`http://localhost:3000/api/modules/${moduleId}`, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const module = await response.json();

                    if (response.ok) {
                        document.getElementById('module-video-title').textContent = module.title; 
                        document.getElementById('module-description').textContent = module.description; 
                        document.getElementById('module-difficulty').textContent = module.difficulty; 

                        if (module.video_url) {
                            const urlParts = module.video_url.split('/');
                            let videoId = urlParts[urlParts.length - 1]; 
                            if (videoId.includes('?')) {
                                videoId = videoId.split('?')[0];
                            }
                            if (videoId.includes('#')) {
                                videoId = videoId.split('#')[0];
                            }
                            const youtubeEmbedUrl = `https://www.youtube.com/embed/${videoId}`;
                            document.getElementById('module-video-iframe').src = youtubeEmbedUrl; 
                        } else {
                            document.getElementById('module-video-iframe').src = '';
                            console.warn('No video URL available for this module.');
                        }
                        
                        document.getElementById('module-xp').textContent = '50XP'; 
                        document.getElementById('module-duration').textContent = 'Estimasi: 10 Menit'; 
                    } else {
                        if (response.status === 404) { 
                            alert('Module not found.');
                        } else {
                            alert(`Failed to load module details: ${module.message || 'Unknown error.'}`);
                        }
                        window.location.href = 'modul.html'; 
                    }
                } catch (error) {
                    console.error('Error fetching module details:', error);
                    alert('An error occurred while loading module details.');
                    window.location.href = 'modul.html';
                }
            }

            async function logVideoWatch() {
                if (!token) {
                    console.warn('Cannot log video watch: User not logged in.');
                    return;
                }
                try {
                    const response = await fetch('http://localhost:3000/api/users/log-video-watch', { 
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`, 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ moduleId: parseInt(moduleId) })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        console.log('Video watch logged successfully:', data.message); 
                    } else {
                        console.error('Failed to log video watch:', data.message);
                        if (response.status === 401 || response.status === 403) { 
                            localStorage.removeItem('jwtToken');
                        }
                    }
                } catch (error) {
                    console.error('Error logging video watch:', error);
                }
            }

            document.getElementById('start-quiz-btn').addEventListener('click', async function() {
                if (!token) {
                    alert('You need to be logged in to start a quiz.');
                    window.location.href = 'sign-in.html';
                    return;
                }

                try {
                    const quizCheckResponse = await fetch(`http://localhost:3000/api/quizzes/module/${moduleId}`, { 
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (quizCheckResponse.ok) {
                        window.location.href = `quiz-page.html?moduleId=${moduleId}`;
                    } else {
                        const errorData = await quizCheckResponse.json();
                        if (quizCheckResponse.status === 403) { 
                            alert('You must complete the module before attempting the quiz.');
                        } else if (quizCheckResponse.status === 404) { 
                            alert('No quiz found for this module, or module is not yet ready for quiz.');
                        } else if (quizCheckResponse.status === 401) { 
                             alert('Session expired. Please log in again.');
                             localStorage.removeItem('jwtToken');
                             window.location.href = 'sign-in.html';
                        } else {
                            alert(`Failed to start quiz: ${errorData.message || 'Unknown error.'}`);
                        }
                    }
                } catch (error) {
                    console.error('Error checking quiz availability:', error);
                    alert('An error occurred while trying to start the quiz. Please try again.');
                }
            });

            await fetchModuleDetails();
            logVideoWatch(); 
        });
    </script>
    <script src="../JavaScript/navbar-scroll.js"></script>
    <script src="../JavaScript/mobile-toggle.js"></script>
</body>
</html>