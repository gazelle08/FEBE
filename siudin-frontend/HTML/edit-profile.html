<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiUdin - Video Pengantar Untuk Pecahan</title>
    <link rel="stylesheet" href="../CSS/detail-module.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <div class="logo-icon"><img src="../Asset/Logo.png" alt=""></div>
                <h1 class="welcome-title">Si<span>Udin</span></h1>    
            </div>              
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <ul class="nav-menu">
                <li><a href="../HTML/home.html" class="nav-link">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="nav-link active">Fitur<i class="fas fa-chevron-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="../HTML/modul.html" class="dropdown-item">Module</a></li>
                        <li><a href="../HTML/missions.html" class="dropdown-item">Mission</a></li>
                        <li><a href="../HTML/leaderboard.html" class="dropdown-item">Leaderboard</a></li>
                    </ul>
                </li>
                <li><a href="../HTML/dashboard.html" class="nav-link">Dashboard</a></li>
            </ul>
            <div class="nav-actions">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <div class="user-profile">
                    <a href="../HTML/dashboard.html"><img src="../Asset/avatar-dashboard.png" alt="User Profile" class="profile-img"></a>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="video-section">
            <h2 class="video-title" id="module-video-title"></h2>
            <div class="video-container">
                <iframe 
                    id="module-video-iframe"
                    src="" 
                    title="Video Pengantar Untuk Pecahan" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
        </section>

        <section class="content-section">
            <div class="description-container">
                <h3 class="section-title">Description</h3>
                <p class="description-text" id="module-description">
                </p>
                <div class="video-meta">
                    <p><strong>Durasi Video:</strong> <span id="module-duration">N/A</span></p>
                    <p><strong>Tingkat Kesulitan:</strong> <span id="module-difficulty"></span></p>
                    <p><strong>Hingga <span id="module-xp">50XP</span></strong></p>
                </div>
                <button class="quiz-btn" id="start-quiz-btn">Start Quiz</button>
            </div>

            <div class="journey-container">
                <div class="journey-box">
                    <h3 class="journey-title">Your Math Journey</h3>
                    <div class="lesson completed">
                        <span class="check-icon"><i class="fas fa-check-circle"></i></span>
                        <div class="lesson-info">
                            <p class="lesson-code">MTH001:</p>
                            <p class="lesson-name">Pengantar Untuk Pecahan</p>
                        </div>
                    </div>
                    <div class="lesson next">
                        <span class="next-icon"><i class="fas fa-arrow-right"></i></span>
                        <p class="lesson-name">Next Video</p>
                    </div>
                    <div class="lesson locked">
                        <span class="lock-icon"><i class="fas fa-lock"></i></span>
                        <p class="lesson-name">Persamaan Linear dan Variabel</p>
                    </div>
                </div>

                <div class="question-box">
                    <div class="question-header">
                        <i class="fas fa-comments"></i>
                        <h3 class="question-title">What did you learn from this video?</h3>
                    </div>
                    <div class="question-content">
                        <p>Ask Question Bellow</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="navigation-section">
            <button class="nav-btn back" onclick="window.location.href='modul.html'">Back To Module</button>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 class="footer-brand">Si<span>Udin</span></h4>
                    <p>Contact Us</p>
                    <p>support@siudin.com</p>
                </div>
                <div class="footer-section">
                    <h4>Menu</h4>
                    <ul>
                        <li><a href="../HTML/home.html">Home</a></li>
                        <li><a href="#">Fitur</a></li>
                        <li><a href="#">Insights</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Help</h4>
                    <ul>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Follow Us</h4>
                    <div class="social-links">
                        <a href="#"><img src="../Asset/face book.png" alt=""></a>
                        <a href="#"><img src="../Asset/twitter.png" alt=""></a>
                        <a href="#"><img src="../Asset/instagram.png" alt=""></a>
                        <a href="#"><img src="../Asset/youtub.png" alt=""></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Â© 2025 SiUdin. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

<script type="module">
  // PASTIKAN BARIS INI ADA DI SINI
  import { supabase } from '../JavaScript/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const moduleId = urlParams.get('moduleId');
            
            // Mendapatkan user saat ini menggunakan Supabase SDK
            const { data: { user }, error: userSessionError } = await supabase.auth.getUser();

            if (!moduleId) {
                alert('Module ID is missing from the URL.');
                window.location.href = 'modul.html';
                return;
            }

            async function fetchModuleDetails() {
                try {
                    // Mengambil data modul langsung dari tabel 'modules' di Supabase
                    const { data: module, error: moduleError } = await supabase
                        .from('modules') // Nama tabel modul Anda
                        .select('*')
                        .eq('id', moduleId)
                        .single(); // Ambil satu modul saja

                    if (moduleError && moduleError.code !== 'PGRST116') { // PGRST116 adalah "No rows found"
                        throw moduleError;
                    }

                    if (module) {
                        document.getElementById('module-video-title').textContent = module.title;
                        document.getElementById('module-description').textContent = module.description;
                        document.getElementById('module-difficulty').textContent = module.difficulty;

                        if (module.video_url) {
                            const urlParts = module.video_url.split('/');
                            let videoId = urlParts[urlParts.length - 1]; 
                            if (videoId.includes('?')) {
                                videoId = videoId.split('?')[0];
                            }
                            if (videoId.includes('#')) {
                                videoId = videoId.split('#')[0];
                            }
                            // Perbaiki URL embed YouTube ke format yang benar
                            const youtubeEmbedUrl = `https://www.youtube.com/embed/${videoId}`; 
                            document.getElementById('module-video-iframe').src = youtubeEmbedUrl;
                        } else {
                            document.getElementById('module-video-iframe').src = '';
                            console.warn('No video URL available for this module.');
                        }
                        
                        // Pastikan kolom xp_reward dan duration_minutes ada di tabel Supabase Anda
                        document.getElementById('module-xp').textContent = `${module.xp_reward || 50} XP`; 
                        document.getElementById('module-duration').textContent = `Estimasi: ${module.duration_minutes || 10} Menit`; 
                    } else {
                        alert('Module not found.');
                        window.location.href = 'modul.html';
                    }
                } catch (error) {
                    console.error('Error fetching module details:', error);
                    alert('An error occurred while loading module details.');
                    window.location.href = 'modul.html';
                }
            }

            async function logVideoWatch() {
                // Pastikan user login untuk log video watch
                if (!user) { // Menggunakan objek user yang didapatkan dari Supabase SDK
                    console.warn('Cannot log video watch: User not logged in.');
                    return;
                }
                try {
                    // Panggil Supabase Function (RPC) untuk log video watch
                    const { data, error } = await supabase.rpc('log_video_watch', { 
                        p_user_id: user.id, 
                        p_module_id: parseInt(moduleId) 
                    });

                    if (error) throw error;

                    console.log('Video watch logged successfully:', data.message); 
                } catch (error) {
                    console.error('Error logging video watch:', error);
                }
            }

            document.getElementById('start-quiz-btn').addEventListener('click', async function() {
                // Pastikan user login untuk memulai kuis
                if (!user) { // Menggunakan objek user yang didapatkan dari Supabase SDK
                    alert('You need to be logged in to start a quiz.');
                    window.location.href = 'sign-in.html';
                    return;
                }

                try {
                    // Panggil Supabase Function (RPC) untuk memeriksa ketersediaan kuis
                    const { data: quizStatus, error: quizError } = await supabase.rpc('check_quiz_availability', { 
                        p_user_id: user.id, 
                        p_module_id: parseInt(moduleId) 
                    });

                    if (quizError) throw quizError;

                    if (quizStatus.can_start_quiz) { // Asumsi fungsi mengembalikan objek dengan properti can_start_quiz
                        window.location.href = `quiz-page.html?moduleId=${moduleId}`;
                    } else {
                        alert(quizStatus.message); // Pesan dari fungsi Supabase
                    }
                } catch (error) {
                    console.error('Error checking quiz availability:', error);
                    alert('An error occurred while trying to start the quiz. Please try again.');
                }
            });

            await fetchModuleDetails();
            // Panggil logVideoWatch hanya jika user sudah login dan tidak ada error sesi
            if (user && !userSessionError) { 
                logVideoWatch(); 
            }
        });
    </script>
    <script src="../JavaScript/navbar-scroll.js"></script>
    <script src="../JavaScript/mobile-toggle.js"></script>
</body>
</html>