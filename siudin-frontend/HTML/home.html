<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiUdin - Learning Platform</title>
    <link rel="stylesheet" href="../CSS/home.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <div class="logo-icon"><img src="../Asset/Logo.png" alt=""></div>
                <h1 class="welcome-title">Si<span>Udin</span></h1>    
            </div>              
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="nav-link active">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="nav-link">Fitur<i class="fas fa-chevron-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="../HTML/modul.html" class="dropdown-item">Module</a></li>
                        <li><a href="../HTML/missions.html" class="dropdown-item">Mission</a></li>
                        <li><a href="../HTML/leaderboard.html" class="dropdown-item">Leaderboard</a></li>
                    </ul>
                </li>
                <li><a href="../HTML/dashboard.html" class="nav-link">Dashboard</a></li>
            </ul>
            <div class="nav-actions">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <div class="user-profile">
                    <a href="../HTML/dashboard.html"><img src="../Asset/avatar-dashboard.png" alt="User Profile" class="profile-img"></a>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <section class="welcome-section">
            <div class="welcome-card">
                <div class="welcome-content">
                    <h1 class="welcome-title">Hello, <span id="welcome-username">Siti</span></h1>
                    <div class="user-info">
                        <img src="../Asset/avatar-dashboard.png" alt="Siti Lestari" class="user-avatar">
                        <div class="user-details">
                            <h3 class="user-name" id="user-full-name">Siti Lestari</h3>
                            <div class="user-stats">
                                <span class="level-badge" id="user-level">Level 1</span>
                                <span class="xp-count" id="user-xp">0 XP</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="search-section">
            <h2 class="search-title">Search</h2>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search your favorite lessons">
                <button class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </section>

        <section class="missions-section">
            <div class="missions-header">
                <h2 class="missions-title">Your Daily Missions</h2>
                <p class="missions-subtitle">Complete missions to earn XP, badges, and level up faster!</p>
                
                <div class="progress-indicator" id="daily-mission-progress">
                    </div>
            </div>

            <div class="missions-content">
                <div class="missions-list" id="daily-missions-list">
                    </div>

                <div class="xp-card">
                    <h3 class="xp-title">Today's XP</h3>
                    <div class="xp-progress">
                        <span class="xp-current" id="today-xp-current">0</span>
                        <span class="xp-separator">/</span>
                        <span class="xp-total" id="today-xp-total">150</span>
                    </div>
                    <div class="xp-bar">
                        <div class="xp-fill" style="width: 0%" id="xp-fill"></div>
                    </div>
                    
                    <div class="level-info">
                        <h4 class="current-level-title">Current Level</h4>
                        <p class="current-level" id="current-level-info">Level 1</p>
                        
                        <h4 class="next-unlock-title">Next Unlock</h4>
                        <p class="next-unlock" id="next-unlock-info">Loading...</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="modules-section">
            <div class="modules-header">
                <h2 class="modules-title">Recommended Modules</h2>
                <p class="modules-subtitle">SiUdin is a platform that can help increase school children's interest and knowledge.</p>
            </div>

            <div class="modules-grid" id="recommended-modules-grid">
                </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 class="footer-brand">Si<span>Udin</span></h4>
                    <p>Contact Us</p>
                    <p>support@siudin.com</p>
                </div>
                <div class="footer-section">
                    <h4>Menu</h4>
                    <ul>
                        <li><a href="../HTML/home.html">Home</a></li>
                        <li><a href="#">Fitur</a></li>
                        <li><a href="#">Insights</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Help</h4>
                    <ul>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Follow Us</h4>
                    <div class="social-links">
                        <a href="#"><img src="../Asset/face book.png" alt=""></a>
                        <a href="#"><img src="../Asset/twitter.png" alt=""></a>
                        <a href="#"><img src="../Asset/instagram.png" alt=""></a>
                        <a href="#"><img src="../Asset/youtub.png" alt=""></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© 2025 SiUdin. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

<script type="module">
  import { supabase } from '../JavaScript/supabaseClient.js';
        document.addEventListener('DOMContentLoaded', async function() {
            const { data: { user }, error: userSessionError } = await supabase.auth.getUser();

            if (userSessionError || !user) {
                alert('You need to be logged in to view this page.');
                window.location.href = 'sign-in.html';
                return;
            }

        async function fetchUserProfile() {
            try {
                // Data user sudah ada dari panggilan awal 'supabase.auth.getUser()'
                document.getElementById('welcome-username').textContent = user.user_metadata.full_name?.split(' ')[0] || user.email; // Ambil nama depan
                document.getElementById('user-full-name').textContent = user.user_metadata.full_name || user.email;
                
                // Ambil user_stats dari tabel 'user_stats' di Supabase Database
                const { data: stats, error: statsError } = await supabase
                    .from('user_stats') // Nama tabel Anda di Supabase
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (statsError && statsError.code !== 'PGRST116') { // PGRST116 adalah "No rows found"
                    console.error('Error fetching user stats:', statsError.message);
                }

                if (stats) {
                    document.getElementById('user-level').textContent = `Level ${stats.level}`;
                    document.getElementById('user-xp').textContent = `${stats.xp} XP`;
                    document.getElementById('current-level-info').textContent = `Level ${stats.level}`;

                    const nextLevelXP = (stats.level + 1) * 100;
                    const xpIntoCurrentLevel = stats.xp % 100;
                    const progressPercentage = (xpIntoCurrentLevel / 100) * 100;

                    document.getElementById('next-unlock-info').textContent = `Next Level at ${nextLevelXP} XP`;
                    document.getElementById('xp-fill').style.width = `${progressPercentage}%`;
                    document.getElementById('today-xp-current').textContent = stats.xp; 
                    document.getElementById('today-xp-total').textContent = nextLevelXP;
                } else {
                    // Default values if no stats found for the user
                    document.getElementById('user-level').textContent = `Level 1`;
                    document.getElementById('user-xp').textContent = `0 XP`;
                    document.getElementById('current-level-info').textContent = `Level 1`;
                    document.getElementById('next-unlock-info').textContent = `Next Level at 100 XP`;
                    document.getElementById('xp-fill').style.width = `0%`;
                    document.getElementById('today-xp-current').textContent = `0`;
                    document.getElementById('today-xp-total').textContent = `100`;
                }

            } catch (error) {
                console.error('Error fetching user profile:', error);
            }
        }
            // Fetch Daily Missions
            async function fetchDailyMissions() {
                try {
                    const { data: missions, error: missionsError } = await supabase
                        .from('daily_missions') 
                        .select(`
                            id,
                            title,
                            description,
                            type,
                            xp_reward,
                            target_value,
                            target_module_id,
                            user_mission_progress!left(
                                is_completed,
                                current_progress,
                                required_completion_count
                            )
                        `)
                        .eq('user_mission_progress.user_id', user.id); // Filter untuk user saat ini

                    if (missionsError) throw missionsError;

                    if (missions) {
                        const missionsList = document.getElementById('daily-missions-list');
                        missionsList.innerHTML = ''; // Clear previous missions
                        let completedMissionsCount = 0;

                        missions.forEach(mission => {
                            const userProgress = mission.user_mission_progress[0]; // Ambil objek progress user
                            const isCompleted = userProgress?.is_completed || false;
                            const currentProgress = userProgress?.current_progress || 0;
                            const requiredCompletionCount = userProgress?.required_completion_count || 0;

                            const missionCard = document.createElement('div');
                            missionCard.classList.add('mission-card');
                            if (isCompleted) { 
                                missionCard.classList.add('completed'); 
                                completedMissionsCount++;
                            }

                            missionCard.innerHTML = `
                                <div class="mission-icon">
                                    <i class="${getMissionIcon(mission.type)}"></i>
                                </div>
                                <div class="mission-info">
                                    <h3 class="mission-title">${mission.title}</h3>
                                    <p class="mission-desc">${mission.description}</p>
                                    <p class="mission-time">Time limit: Today (23:59)</p> <p class="mission-reward">Reward: ${mission.xp_reward} XP</p>
                                </div>
                                <button class="mission-btn ${isCompleted ? 'completed' : 'primary'}" 
                                        data-mission-id="${mission.id}" 
                                        data-is-completed="${isCompleted}"
                                        ${isCompleted || currentProgress < requiredCompletionCount ? 'disabled' : ''}>
                                    ${isCompleted ? 'Completed' : 'Claim'}
                                </button>
                            `;
                            missionsList.appendChild(missionCard);
                        });

                        // Add event listener for "Claim" button
                        missionsList.querySelectorAll('.mission-btn.primary').forEach(button => {
                            button.addEventListener('click', async function() {
                                const missionId = this.dataset.missionId;
                                try {
                                    // Panggil Supabase Function (RPC) untuk mengklaim misi
                                    const { data, error } = await supabase.rpc('claim_mission', { p_mission_id: parseInt(missionId), p_user_id: user.id });

                                    if (error) throw error;

                                    alert(data.message);
                                    fetchUserProfile(); // Refresh user XP and level
                                    fetchDailyMissions(); // Refresh mission list
                                } catch (error) {
                                    console.error('Error claiming mission:', error.message);
                                    alert(`Failed to claim mission: ${error.message}`);
                                }
                            });
                        });


                        // Update progress indicator
                        const progressIndicator = document.getElementById('daily-mission-progress');
                        progressIndicator.innerHTML = ''; // Clear existing indicators
                        const totalDailyMissions = missions.length;
                        for (let i = 0; i < totalDailyMissions; i++) {
                            const step = document.createElement('div');
                            step.classList.add('progress-step');
                            if (i < completedMissionsCount) {
                                step.classList.add('completed');
                                step.innerHTML = '<i class="fas fa-check"></i>';
                            } else {
                                step.textContent = String(i + 1).padStart(2, '0');
                            }
                            progressIndicator.appendChild(step);
                            if (i < totalDailyMissions - 1) {
                                const line = document.createElement('div');
                                line.classList.add('progress-line');
                                if (i < completedMissionsCount - 1) {
                                    line.classList.add('completed');
                                }
                                progressIndicator.appendChild(line);
                            }
                        }

                    } else {
                        console.error('No daily missions found.');
                    }
                } catch (error) {
                    console.error('Error fetching daily missions:', error);
                }
            }

            function getMissionIcon(missionType) {
                switch (missionType) {
                    case 'watch_video':
                        return 'fas fa-play-circle';
                    case 'complete_quiz':
                        return 'fas fa-check-circle';
                    case 'daily_login': 
                        return 'fas fa-sign-in-alt';
                    default:
                        return 'fas fa-tasks';
                }
            }

            // Fetch Recommended Modules
            async function fetchRecommendedModules() {
                try {
                    const { data: modules, error: modulesError } = await supabase
                        .from('modules') 
                        .select('*')
                        .limit(6); 

                    if (modulesError) throw modulesError;

                    if (modules) {
                        const modulesGrid = document.getElementById('recommended-modules-grid');
                        modulesGrid.innerHTML = ''; 
                        modules.forEach(module => {
                            const moduleCard = document.createElement('div');
                            moduleCard.classList.add('module-card');
                            moduleCard.innerHTML = `
                                <div class="module-image">
                                    <img src="../Asset/modul-mtk.png?height=120&width=200" alt="${module.title}">
                                </div>
                                <div class="module-content">
                                    <h3 class="module-title">${module.title}</h3>
                                    <p class="module-subject">${module.topic} • ${module.class_level} Grade</p>
                                    <button class="module-action-btn" onclick="window.location.href='detail-module.html?moduleId=${module.id}'">
                                        Continue
                                    </button>
                                </div>
                                <div class="module-progress">
                                    <span class="progress-text">Not Started</span> <div class="progress-bar">
                                        <div class="progress-fill" style="width: 0%"></div>
                                    </div>
                                </div>
                            `;
                            modulesGrid.appendChild(moduleCard);
                        });
                    } else {
                        console.error('No recommended modules found.');
                    }
                } catch (error) {
                    console.error('Error fetching recommended modules:', error);
                }
            }

            // Initial data load
            fetchUserProfile();
            fetchDailyMissions();
            fetchRecommendedModules();
        });
</script>
 <script src="../JavaScript/navbar-scroll.js"></script>
 <script src="../JavaScript/mobile-toggle.js"></script>
</body>
</html>